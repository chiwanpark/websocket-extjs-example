Ext.define("Ext.ux.WebSocket",{alias:"widget.websocket",mixins:{observable:"Ext.util.Observable"},requires:["Ext.util.TaskManager"],config:{url:"",protocol:null,communicationType:"both",autoReconnect:!0,autoReconnectInterval:5e3},CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3,constructor:function(a){var b=this;if(Ext.isEmpty(a))return Ext.Error.raise("URL for the websocket is required!"),null;"string"==typeof a&&(a={url:a}),b.initConfig(a),b.mixins.observable.constructor.call(b,a),b.addEvents("open","error","close","message");try{b.initWebsocket()}catch(c){return Ext.Error.raise(c),null}return b},isReady:function(){return this.getStatus()===this.OPEN},getStatus:function(){return this.ws.readyState},close:function(){var a=this;return a.autoReconnectTask&&(Ext.TaskManager.stop(a.autoReconnectTask),delete a.autoReconnectTask),a.ws.close(),a},send:function(){},initWebsocket:function(){var a=this;a.ws=Ext.isEmpty(a.getProtocol())?new WebSocket(a.getUrl()):new WebSocket(a.getUrl(),a.getProtocol()),a.ws.onopen=function(){a.autoReconnectTask&&(Ext.TaskManager.stop(a.autoReconnectTask),delete a.autoReconnectTask),a.fireEvent("open",a)},a.ws.onerror=function(b){a.fireEvent("error",a,b)},a.ws.onclose=function(){a.fireEvent("close",a),a.getAutoReconnect()&&"undefined"==typeof a.autoReconnectTask&&(a.autoReconnectTask=Ext.TaskManager.start({run:function(){a.getStatus()===a.CLOSED&&a.initWebsocket()},interval:a.getAutoReconnectInterval()}))},"both"===a.getCommunicationType()?(a.ws.onmessage=Ext.bind(a.receiveBothMessage,this),a.send=Ext.bind(a.sendBothMessage,this)):"event"===a.getCommunicationType()?(a.ws.onmessage=Ext.bind(a.receiveEventMessage,this),a.send=Ext.bind(a.sendEventMessage,this)):(a.ws.onmessage=Ext.bind(a.receiveTextMessage,this),a.send=Ext.bind(a.sendTextMessage,this))},receiveBothMessage:function(a){var b=this;try{var c=Ext.JSON.decode(a.data);b.fireEvent(c.event,b,c.data),b.fireEvent("message",b,c)}catch(d){Ext.isString(a.data)&&b.fireEvent(a.data,b,a.data),b.fireEvent("message",b,a.data)}},receiveEventMessage:function(a){var b=this;try{var c=Ext.JSON.decode(a.data);b.fireEvent(c.event,b,c.data),b.fireEvent("message",b,c)}catch(d){Ext.Error.raise(d)}},receiveTextMessage:function(a){var b=this;try{b.fireEvent(a,b,a),b.fireEvent("message",b,a)}catch(c){Ext.Error.raise(c)}},sendBothMessage:function(a,b){if(1===arguments.length)Ext.isString(a)?this.ws.send(a):Ext.Error.raise("String expected!");else if(arguments.length>=2){a=Ext.isString(a)?[a]:a;for(var c=0;c<a.length;c++){var d={event:a[c],data:b};this.ws.send(Ext.JSON.encode(d))}}return this},sendEventMessage:function(a,b){a=Ext.isString(a)?[a]:a;for(var c=0;c<a.length;c++){var d={event:a[c],data:b};this.ws.send(Ext.JSON.encode(d))}return this},sendTextMessage:function(a){return this.ws.send(a),this}});